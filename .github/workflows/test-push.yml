---
name: Test Push
on:
  push:
    branches:
      - main
jobs:
  test_go:
    strategy:
      matrix:
        go-version: [1.25.x]
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}
    permissions:
      # kics-scan ignore-line
      id-token: write
      contents: read
    environment: production
    steps:
      - uses: actions/checkout@v6

      # https://github.com/google-github-actions/auth/tree/v2.1.13
      - uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.REGISTRY_SERVICE_ACCOUNT_EMAIL }}

      # https://github.com/google-github-actions/setup-gcloud/tree/v2.1.5
      - uses: google-github-actions/setup-gcloud@6a7c903a70c8625ed6700fa299f5ddb4ca6022e9

      - uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go-version }}

      # https://github.com/bazel-contrib/setup-bazel/tree/0.15.0
      - uses: bazel-contrib/setup-bazel@43d7d5ceab59a307da44fc7585faa2a2fff4f88d
        with:
          bazelisk-version: 1.x

      # - name: Mount bazel cache
      #   id: bazel_cache
      #   uses: actions/cache@v4
      #   with:
      #     path: ~/.cache/bazel
      #     key: bazel

      # - name: Check cache
      #   run: echo "cache=${{ steps.bazel_cache.outputs.cache-hit }}"

      - run: bazel info

      # https://github.com/arduino/setup-task/tree/v2.0.0
      - uses: arduino/setup-task@b91d5d2c96a56797b48ac1e0e89220bf64044611
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - run: task test-remote

      # - name: Convert coverage to SonarQube format
      #   run: task convert-coverage-sonar

      # https://github.com/codecov/codecov-action/tree/v5.4.3
      - uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.lcov
          slug: mocoarow/cocotola-1.25

      # - uses: actions/upload-artifact@v4
      #   with:
      #     name: ${{ github.sha }}-coverage-result
      #     path: |
      #       coverage.lcov
      #       coverage-sonar.xml
      #     retention-days: 2

  # sonarqube:
  #   name: SonarQube
  #   runs-on: ubuntu-latest
  #   needs: [test_go]
  #   steps:
  #     - uses: actions/checkout@v6
  #       with:
  #         fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

  #     - uses: actions/download-artifact@v4
  #       with:
  #         name: ${{ github.sha }}-coverage-result
  #         path: .

  #     - name: SonarQube Scan
  #       # uses: SonarSource/sonarqube-scan-action@v5
  #       uses: SonarSource/sonarqube-scan-action@5837ebfccaf5b347ae1783644ecff31e2bafa086
  #       env:
  #         SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
